AIチャットCo-Pilot、管理者ログインセクション設計差分

1. 【追加】新しく定義された要素

Safety Brake v1.4 (比喩表現の許容):
内容: 「死ぬほど忙しい」といった飲食店特有の比喩（Metaphor）をAIが「SAFE」と判定するロジックが明文化されました。
技術的影響: AIへのシステムプロンプトに「比喩と具体的殺意の切り分け」の指示を組み込む必要があります。

「処方箋（Prescription）」モデルの厳格化:
内容: 管理者が見るデータから「時刻」「個人名」「生の発言」を物理的に排除することが強調されました。

技術的影響: ダッシュボードのログ閲覧画面において、content_encrypted は復号せず、AIが生成した prescription と summary だけを表示する設計が決定打となりました。

features テーブルのカラム追加:
内容: default_enabled (boolean) が追加されました。
技術的影響: 新規店舗（テナント）が登録された際、自動的にどの機能をONにするかの初期設定ロジックを実装する必要があります。

2. 【変更】既存仕様からの修正・アップデート
暗号化キーのシード (鍵の生成源):
以前: DB_ENCRYPTION_KEY という独立した環境変数。
今回: 「LINE Channel Secretをシードにしたアプリケーション層暗号化」。
技術的影響: crypto モジュールの実装を修正し、process.env.LINE_CHANNEL_SECRET を元に鍵を動的に生成するロジックへ変更が必要です。これにより、インフラ担当者（DB管理者）の閲覧をより困難にする「多層防御」が強化されます。

logs テーブルの定義:
以前: カテゴリやインパクトの分析結果を保存する。
今回: summary (20文字以内) と prescription (具体的な改善アクション) カラムが必須項目として定義されました。

技術的影響: route.ts 内のAI分析（Geminiへの指示）において、20文字という厳しい文字数制限を課したJSON出力を強制する必要があります。


3. 【競合・確認事項】現在の実装とのズレ
ここが重要です。実装を進める前にCEOと合意したい「ねじれ」です。

スタッフ名簿の表示項目:
現状: app/dashboard/page.tsx では、画像で確認した通り「時給（hourly_wage）」や「店長メモ（manager_memo）」を一覧表示しています。
設計図の制約: AIにはこれらを「物理的に隔離」し、参照させない。
CTO判断: 「店長（人間）は名簿から時給を見れるが、AI（共生体）はそれを見れない」という権限の二階層化を徹底します。前スレッドで提示した「AI専用ビュー」がこの解決策になります。

シュレッダーUIの対象:
設計図: 「全てのAI応答に消去ボタンを付与」。
現状: 既に実装済みですが、削除対象が logs テーブルだけで良いか、あるいはAIが一時的に保持するキャッシュ（もしあれば）も対象に含めるか、今後精査します。

🛡️ CTOによる「次スレッド」への持ち越し宣言
これらの差分を踏まえ、次のスレッドでは以下の**「最新仕様パッチ」**を適用した状態で開発を開始します。
暗号化ユーティリティの更新: LINE_CHANNEL_SECRET をベースにした decrypt/encrypt 関数への再定義。
AI分析プロンプトの更新: 「20文字サマリー」と「具体的な処方箋（改善アクション）」を吐き出すように調整。
機能コントロールセンターの default_enabled 対応: スイッチ画面において、マスター設定を反映。